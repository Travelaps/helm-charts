{{ if .Values.sql.runCreationScripts }}
kind: Job
apiVersion: batch/v1
metadata:
  name: sql-create-angus-webhotel
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "-50"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      imagePullSecrets:
        - name: regcred
      containers:
        - name: initial-creator
          image: ghcr.io/travelaps/mssql2019fts:v2
          command:
            - /opt/mssql-tools/bin/sqlcmd
          args:
            - '-S'
            - {{ .Values.sql.connection.server }},{{ .Values.sql.connection.port }}
            - '-U'
            - {{ .Values.sql.connection.user }}
            - '-P'
            - {{ .Values.sql.connection.password }}
            - '-Q'
            - |
              CREATE DATABASE [ANGUS_WEBHOTEL] COLLATE TURKISH_CI_AS
              GO
              ALTER DATABASE [ANGUS_WEBHOTEL] SET RECOVERY SIMPLE
              GO
              ALTER DATABASE [ANGUS_WEBHOTEL] SET AUTO_CLOSE OFF WITH NO_WAIT
              GO
              ALTER DATABASE [ANGUS_WEBHOTEL] SET AUTO_CREATE_STATISTICS OFF
              GO
              ALTER DATABASE [ANGUS_WEBHOTEL] SET AUTO_UPDATE_STATISTICS OFF WITH NO_WAIT
              GO
              USE [ANGUS_WEBHOTEL]
              GO
              ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 1
              GO
              ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET MAXDOP = 1
              GO
              USE [ANGUS_WEBHOTEL]
              GO
              /****** Object:  Synonym [dbo].[ANGUSDEVELOPER]    Script Date: 17.08.2021 4:34:34 PM ******/
              CREATE SYNONYM [dbo].[ANGUSDEVELOPER] FOR [ERSDEVELOPER].[dbo].[ANGUSDEVELOPER]
              GO
              /****** Object:  Synonym [dbo].[LOG]    Script Date: 17.08.2021 4:34:34 PM ******/
              CREATE SYNONYM [dbo].[LOG] FOR [EMDS_LOGS].[dbo].[LOG_ELEKTRAWEB]
              GO
              /****** Object:  Synonym [dbo].[STDUSER]    Script Date: 17.08.2021 4:34:34 PM ******/
              CREATE SYNONYM [dbo].[STDUSER] FOR [EMDS].[dbo].[STDUSER]
              GO
              /****** Object:  Synonym [dbo].[STDUSER_LOGIN]    Script Date: 17.08.2021 4:34:34 PM ******/
              CREATE SYNONYM [dbo].[STDUSER_LOGIN] FOR [EMDS].[dbo].[STDUSER_LOGIN]
              GO
              /****** Object:  Synonym [dbo].[STDUSERAGENT]    Script Date: 17.08.2021 4:34:34 PM ******/
              CREATE SYNONYM [dbo].[STDUSERAGENT] FOR [EMDS].[dbo].[STDUSERAGENT]
              GO
              /****** Object:  UserDefinedFunction [dbo].[HMAC]    Script Date: 17.08.2021 4:34:34 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE FUNCTION [dbo].[HMAC] (
              @algo VARCHAR(20)
              ,@keySTR VARCHAR(MAX)
              ,@dataSTR VARCHAR(MAX)
              )
              /* This function only takes VARBINARY parameters instead of VARCHAR
              to prevent problems with implicit conversion from NVARCHAR to VARCHAR
              which result in incorrect hashes for inputs including non-ASCII characters.
              Always cast @key and @data parameters to VARBINARY when using this function.
              Tested against HMAC vectors for MD5 and SHA1 from RFC 2202 */

              /*
              List of secure hash algorithms (parameter @algo) supported by MSSQL
              version. This is what is passed to the HASHBYTES system function.
              Omit insecure hash algorithms such as MD2 through MD5
              2005-2008R2: SHA1
              2012-2016: SHA1 | SHA2_256 | SHA2_512
              */
              RETURNS VARBINARY(64)
              AS
              BEGIN
              DECLARE @key VARBINARY(MAX) = cast(@keySTR as varbinary(max)),
              		@data VARBINARY(MAX) = cast(@dataSTR as varbinary(max))

              DECLARE @ipad BIGINT
              DECLARE @opad BIGINT
              DECLARE @i VARBINARY(64)
              DECLARE @o VARBINARY(64)
              DECLARE @pos INTEGER

              --SQL 2005 only allows XOR operations on integer types, so use bigint and interate 8 times
              SET @ipad = cast(0x3636363636363636 AS BIGINT) --constants from HMAC definition
              SET @opad = cast(0x5C5C5C5C5C5C5C5C AS BIGINT)

              IF len(@key) > 64 --if the key is grater than 512 bits we hash it first per HMAC definition
              SET @key = cast(hashbytes(@algo, @key) AS BINARY (64))
              ELSE
              SET @key = cast(@key AS BINARY (64)) --otherwise pad it out to 512 bits with zeros

              SET @pos = 1
              SET @i = cast('' AS VARBINARY(64)) --initialize as empty binary value

              WHILE @pos <= 57
              BEGIN
              SET @i = @i + cast((substring(@key, @pos, 8) ^ @ipad) AS VARBINARY(64))
              SET @pos = @pos + 8
              END

              SET @pos = 1
              SET @o = cast('' AS VARBINARY(64)) --initialize as empty binary value

              WHILE @pos <= 57
              BEGIN
              SET @o = @o + cast((substring(@key, @pos, 8) ^ @opad) AS VARBINARY(64))
              SET @pos = @pos + 8
              END

              RETURN hashbytes(@algo, @o + hashbytes(@algo, @i + @data))
              END
              GO
              /****** Object:  Table [dbo].[PUBLICUSERS]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[PUBLICUSERS](
              	[ID] [int] IDENTITY(1,1) NOT NULL,
              	[DOMAIN] [nvarchar](100) NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[ID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
              UNIQUE NONCLUSTERED
              (
              	[DOMAIN] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  View [dbo].[VW_USER]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO









              CREATE VIEW [dbo].[VW_USER]
              AS

                  SELECT
                      U.ID AS USERID, U.[USERCODE], CONVERT(NVARCHAR(200),U.[PASSWORD64],2) AS [PASSWORD], U.[ROLEID], R.ROLENAME, U.SUPERADMIN,
                      CASE WHEN ISNULL(U.SUPERADMIN,0)= 1 THEN 99 ELSE /*U.ADMINLEVEL*/0/*USER KENDI ADMIN LEVELINI YUKSELTEBILIR!!*/ END AS ADMINLEVEL,
                      CASE WHEN ISNULL(U.SUPERADMIN,0)=1 OR ISNULL(U.ADMINLEVEL,0)=99 THEN NULL WHEN R.ONLYAPPLICATION = 'webportal' THEN 'PORTALID' ELSE 'HOTELID' END AS[TENNANTCOLUMN1],
                      CASE WHEN ISNULL(U.SUPERADMIN,0)=1 OR ISNULL(U.ADMINLEVEL,0)=99 THEN NULL WHEN R.ONLYAPPLICATION = 'webportal' THEN U.PORTALID ELSE U.HOTELID END AS[TENNANTVALUE1],
                      CASE WHEN ISNULL(U.SUPERADMIN,0)=1 OR ISNULL(U.ADMINLEVEL,0)=99 THEN NULL ELSE R.TENNANTFILTERFIELDNAME  END AS [TENNANTCOLUMN2],
                      CASE WHEN ISNULL(U.SUPERADMIN,0)=1 OR ISNULL(U.ADMINLEVEL,0)=99 THEN NULL ELSE U.PORTALSELLERID          END AS[TENNANTVALUE2],

              		NULLIF(
              			/*USER'IN ANA USERIDAN GELEN VEYA KENDINDEN GELEN*/
              			ISNULL(CASE WHEN U.SUBUSER = 1 THEN cast('10.0.0.0' as varchar(500)) ELSE U.IPADDRESS END,'')+
              			/*USER'IN OTELINDEN GELEN*/
              			ISNULL(CASE WHEN U.SUBUSER = 1 OR ISNULL(U.IPADDRESS,'') <> '' THEN ',' ELSE '' END+H.IPWHITELIST,'')+
              			/*USERIN OTELININ BAGLI OLDUGU GRUPTAN GELEN*/
              			ISNULL(CASE WHEN U.SUBUSER = 1 OR ISNULL(U.IPADDRESS,'') <> '' OR ISNULL(H.IPWHITELIST,'')<>'' THEN ',' ELSE '' END+G.IPADDRESS,'')
              			,
              			''
              		)

              		AS IPADDRESS,
                      CONVERT(NVARCHAR(5),U.CANLOGINFROM,108) AS [CANLOGINFROM],
                      CONVERT(NVARCHAR(5),U.CANLOGINTO  ,108) AS [CANLOGINTO],

              		CONVERT(NVARCHAR(MAX),(
              			SELECT cast(UR.ROLEID as nvarchar)+','
              			FROM EMDS.dbo.STDUSER_ROLES UR WITH(NOLOCK)
              			WHERE UR.USERID = U.ID
              			FOR XML PATH('')
              		))AS ROLEIDS,

              		/*U.*/ CAST(0 AS BIT) AS ROLELEARNERMODE,
              		U.EMAIL,
              		ISNULL(CASE WHEN U.SUBUSER = 1 THEN 4  END,U.[2FASTATE]) AS [2FASTATE] ,
              		ISNULL(CASE WHEN U.SUBUSER = 1 THEN cast('' as varchar(100)) END,U.[2FAKEY]) AS [2FAKEY],

              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,

              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		CASE WHEN U.ID > 0 THEN N'Admin Menu' ELSE '' END+ISNULL((
              			SELECT TOP(1)
              				CASE WHEN U.ID > 0 AND S.MODULE_PMSMODE = 0 THEN ',Reservation,Front Desk,Front Office,Front Cash,Night Audit,CRM,Contract Management,Housekeeping,Technical Service,Security Service,Food And Beverage,Hotel Transfer List' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_STOCK,0)=0 THEN ',Stock and Inventory' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_SALESANDMARKETING,0)=0 THEN ',Sales and Marketing' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_PURCHASING,0)=0 THEN ',Purchasing,Purchasing (Old)' ELSE '' END+
              				CASE WHEN ISNULL(S.GUESTAPPLICATION,0)=0 THEN ',Online Guest Operations' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_ACCOUNTING,0)=0 THEN ',Accounting' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_POS,0)=0 THEN ',POS' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_SPA,0)=0 THEN ',Spa' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_FIXTURE,0)=0 THEN ',Fix Assets' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_PROPERTY_MANAGEMENT,0)=0 THEN ',Property Management' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_CALLCENTER,0)=0 THEN ',Call Center' ELSE '' END+
              				CASE WHEN ISNULL(S.MODULE_RESTAURANT_DIGITALMENU,0)=0 THEN ',Digital Menu' ELSE '' end+
              				CASE WHEN ISNULL(S.MODULE_BOOKINGENGINE,0)=0 AND ISNULL(S.MODULE_CHANNELMANAGER,0)=0 THEN 'Extranet' ELSE '' end
              			FROM EMDS.dbo.HOTEL_SUBSCRIPTION S WITH(NOLOCK)
              			WHERE S.OTELID = U.HOTELID
              			ORDER BY S.ID DESC
              		),'') AS HIDEMENUS,

              		case
              			--2021-03-04:OGUZ:EXPIREDATE KOLONU ASLINDA SERVISIN ICINDE "PASSWORDEXPIREDATE" ANLAMINDA KULLANILIYOR...
              			WHEN U.[SUBUSER]=1 OR U.[HOTELWEBSERVICE] = 1 OR H.PASSWORDEXPIREDAYS IS NULL THEN '2049-12-31'
              			WHEN H.PASSWORDEXPIREDAYS > 0 THEN DATEADD(DAY,H.PASSWORDEXPIREDAYS,ISNULL(U.PASSWORDLASTCHANGED,U.CREATION_DATE))
              		END as [EXPIREDATE],
              		U.LOGOUTTIME,

              		--2021-03-09:OGUZ:API USERLARININ APISEQUENCE KISITLAMALARI
              		STUFF(CONVERT(NVARCHAR(MAX),(
              			SELECT ','+S.[NAME]
              			FROM EMDS.dbo.STDUSER_APISEQUENCE A WITH(NOLOCK)
              			INNER JOIN EMDS.dbo.APISEQUENCE   S WITH(NOLOCK) ON S.ID= A.APISEQUENCEID
              			WHERE A.[USERID] = U.[ID]
              			FOR XML PATH('')
              		)),1,1,'') AS [APISEQUENCE],


              		STUFF((SELECT ','+CAST(GH.ID AS VARCHAR(14))  FROM EMDS..HOTEL GH WITH(NOLOCK) WHERE GH.GROUPID = G.ID AND G.MULTITENANCYENABLED = 1 FOR XML PATH('')),1,1,'')AS  MULTITENNANTVALUE1
                  FROM EMDS.dbo.STDUSER       U WITH(NOLOCK)
                  INNER JOIN EMDS.dbo.HOTEL   H WITH(NOLOCK) ON H.ID = U.HOTELID
              	INNER JOIN EMDS.dbo.STDROLE R WITH(NOLOCK) ON R.ID = U.[ROLEID]
              	LEFT  JOIN EMDS.dbo.HOTEL_GROUP G WITH(NOLOCK) ON G.ID = H.GROUPID
              	WHERE (R.ONLYAPPLICATION IS NULL OR R.ONLYAPPLICATION = 'webhotel' OR U.SUPERADMIN = 1)
                    AND (U.ISDELETED IS NULL  OR U.ISDELETED  = 0)
                    AND (U.ISDISABLED IS NULL OR U.ISDISABLED = 0)
                    AND U.USERCODE IS NOT NULL
              	  AND ISNULL(H.ISDELETED,0)=0
              	  AND ISNULL(H.ISDISABLED,0)=0
              	  AND U.PASSWORD64 IS NOT NULL
              	  AND U.[EXPIREDATE] > cast(getutcdate() as date)--2021-03-04:OGUZ/KEMAL:USERIN EXPIRE OLMASI DEMEK KOMPLE CORTLAMASI DEMEK OLMALI, MESELA DONEMSEL BIRININ ISTEN CIKISI GIBI...

                  UNION ALL
                  SELECT
              		D.ID,D.[USERCODE],CONVERT(NVARCHAR(200),D.[PASSWORD64],2),
              		CASE WHEN ISNULL(D.ROLELEARNERMODE,0)=1 THEN D.ROLEID ELSE 5 END,
              		'Administrator' ,--CASE WHEN ISNULL(D.ROLELEARNERMODE,0)=1 THEN R.ROLENAME ELSE 'Administrator' END,
              		1,D.ADMINLEVEL,'HOTELID',CAST(D.EASYPMSTENANT AS NVARCHAR(20)),NULL,NULL,D.IPADDRESS,NULL,NULL,NULL,D.ROLELEARNERMODE,D.EMAIL ,D.[2FASTATE],D.[2FAKEY],
              		D.BLOCKSETCONFIG,D.BLOCKTRANSLATE,D.ALLOWCONFIGS,D.BLOCKCONFIGS,D.HIDEMENUS,NULL AS [EXPIREDATE],D.LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
              	FROM ERSDEVELOPER..ANGUSDEVELOPER D WITH(NOLOCK)
              	WHERE D.EASYPMSTENANT IS NOT NULL
              	  AND ISNULL(D.[LOGINTIME],'2021-05-27') > DATEADD(DAY,-10,GETUTCDATE())

                  UNION ALL

                  SELECT
              		0,PU.[DOMAIN],'',122,'PublicUser',0,0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,
              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		N'Admin Menu' AS HIDEMENUS,NULL AS [EXPIREDATE],NULL AS LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
                  FROM ANGUS_WEBHOTEL.dbo.PUBLICUSERS PU WITH(NOLOCK)

              	UNION ALL

                  SELECT
              		0,H.CNAME_WEB,'',122,'PublicUser',0,0,'HOTELID',CAST(H.ID AS NVARCHAR(14))/*2020-11-25:OGUZ/TOLGA:APISEQ NOTIF ATABILSIN DIYE*/,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,
              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		N'Admin Menu' AS HIDEMENUS,NULL AS [EXPIREDATE],NULL AS LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
                  FROM EMDS.dbo.HOTEL H WITH(NOLOCK)
              	WHERE H.PORTALID = 1
              	  AND H.CNAME_WEB > ''
              	  AND ISNULL(H.ISDELETED,0)=0

              	UNION ALL

                  SELECT
              		0,H.CNAME,'',122,'PublicUser',0,0,'HOTELID',CAST(H.HOTELID AS NVARCHAR(14))/*2020-11-25:OGUZ/TOLGA:APISEQ NOTIF ATABILSIN DIYE*/,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,
              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		N'Admin Menu' AS HIDEMENUS,NULL AS [EXPIREDATE],NULL AS LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
                  FROM EMDS.dbo.DIGITALMENU_SETTINGS H WITH(NOLOCK)
              	WHERE H.CNAME > ''

              	UNION ALL

              	SELECT
              		0,'portal-'+G.SUBDOMAIN+'.elektrabulut.com','',122,'PublicUser',0,0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,
              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		N'Admin Menu' AS HIDEMENUS,NULL AS [EXPIREDATE],NULL AS LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
                  FROM EMDS.dbo.HOTEL_GROUP G WITH(NOLOCK)
              	WHERE G.PORTALID = 1
              	  AND G.SUBDOMAIN > ''

              	  	UNION ALL

                        SELECT
              		0,'portal-'+G.SUBDOMAIN+'.rezervasyonal.com','',122,'PublicUser',0,0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
              		CAST(1 AS BIT) AS BLOCKSETCONFIG,
              		CAST(1 AS BIT) AS BLOCKTRANSLATE,
              		'' AS ALLOWCONFIGS,
              		'' AS BLOCKCONFIGS,
              		N'Admin Menu' AS HIDEMENUS,NULL AS [EXPIREDATE],NULL AS LOGOUTTIME,NULL AS APISEQUENCE, NULL AS MULTITENNANTVALUE1
                  FROM EMDS.dbo.HOTEL_GROUP G WITH(NOLOCK)
              	WHERE G.PORTALID = 1
              	  AND G.SUBDOMAIN > ''


              GO
              /****** Object:  View [dbo].[ENDPOINT]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO






































              CREATE VIEW [dbo].[ENDPOINT]
              AS
              SELECT
              	H.ID AS [TENANTID],
              	case
              		--WHEN H.ID = 18892 THEN 'https://4001.elektraweb.p.azurewebsites.net'
              		WHEN ISNULL(S.USETRSERVER,0)=1 THEN 'https://4001kk.hoteladvisor.net'

              	ELSE
              		NULL
              		--CAST('https://ers4001.azurefd.net/' AS NVARCHAR(100))
              	END AS [URL],
              	CASE WHEN CHARINDEX('<',H.EMAIL) > 0 THEN H.EMAIL ELSE 'ElektraWeb<'+H.EMAIL+'>' END AS EMAILSENDERADDRESS,
              	A.SMTP_FROM ,
              	A.SMTP_SERVER ,
              	A.SMTP_USER ,
              	A.SMTP_PASS ,
              	A.SMTP_SECURE,
              	A.SMTP_PORT,
              	A.SMTP_TLS,
              	A.SMTP_SENDERFIXED,
              	H.PROGDATE,
              	DATEADD(DAY,1,H.PROGDATE) as PROGDATE_PLUS1,

              	'13.70.199.232,40.69.91.19,'+ISNULL(S.STATICIPS,'') AS STATICIPS,

              	case
              		WHEN @@SERVERNAME = 'WIN-9K0D3H2Q085' THEN NULL
              		--WHEN H.ID = 18892 THEN 'https://4001.elektraweb.p.azurewebsites.net'
              		WHEN ISNULL(S.USETRSERVER,0)=1 THEN 'https://4001tr.elektraweb.com'
              	ELSE
              		NULL
              		--CAST('https://ers4001.azurefd.net/' AS NVARCHAR(100))
              	END AS URLFORSTATICIPS,
              	--2020-10-01:OGUZ
              	CASE ISNULL(SUBS.MODULE_PMSMODE,99) WHEN 0 THEN 'nonpms' WHEN 2 THEN 'midi' WHEN 3  THEN 'mini' ELSE 'std' END AS PACKAGENAME,


              	TZ.HOUROFFSET,TZ.[NAME] AS TIMEZONE,H.SUBDOMAIN
              FROM(
              	SELECT CAST(H.ID AS NVARCHAR(14)) AS ID,H.EMAIL,H.PROGDATE,H.PORTALID,H.TIMEZONEID,H.SUBDOMAIN FROM EMDS.dbo.[HOTEL] H WITH(NOLOCK) WHERE H.PORTALID = 1
              	UNION ALL
              	SELECT '','','2000-01-01',1,NULL,NULL
              )H
              LEFT JOIN EMDS.dbo.[HOTEL_SETTINGS] S WITH(NOLOCK) ON S.HOTELID = H.ID
              LEFT JOIN EMDS.dbo.[HOTEL_SMTPACCOUNTS] A WITH(NOLOCK) ON A.ID = S.SMTPACCOUNTID
              LEFT JOIN EMDS.dbo.[STDTIMEZONE] TZ WITH(NOLOCK) ON TZ.ID = H.TIMEZONEID
              OUTER APPLY(
              	SELECT TOP(1) *
              	FROM EMDS.dbo.HOTEL_SUBSCRIPTION SUBS WITH(NOLOCK)
              	WHERE SUBS.OTELID = H.ID
              	  --AND CAST(GETDATE() AS DATE) BETWEEN SUBS.STARTDATE AND SUBS.ENDDATE
              	ORDER BY SUBS.ENDDATE DESC--SUBS.ID DESC
              )SUBS


              GO
              /****** Object:  View [dbo].[PROXYWHITELIST]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO



              CREATE VIEW [dbo].[PROXYWHITELIST]
              AS
              SELECT 'https://sgkt.sgk.gov.tr:443/WS_SgkTescil4a/WS_SgkIseGirisService'  AS [URL] , cast(null as nvarchar(50)) as [TENNANTVALUE]
              UNION ALL SELECT 'https://uyg.sgk.gov.tr:443/WS_SgkTescil4a/WS_SgkIseGirisService' , NULL as [TENNANTVALUE1]
              UNION ALL SELECT [VALUESTR], cast(HOTELID as nvarchar(50)) as [TENNANTVALUE1] FROM EMDS..HOTEL_CONFIGPARAM WITH(NOLOCK) WHERE KEYSTR = 'SAP Service Url'
              UNION ALL SELECT [EARSIV_SEND_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EFATURA_SEND_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EFATURA_AUTHENTICATION_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [INTEGRATOR_PORTAL_ADDRESS], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EARSIV_AUTHENTICATION_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EFATURA_GETSTATUS_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EARSIV_GETSTATUS_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EARSIV_BACKTODRAFT_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EFATURA_BACKTODRAFT_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EFATURA_GETXSLT_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT [EARSIV_CANCEL_ENDPOINT], NULL FROM EMDS..EFATURA_INTEGRATOR WITH(NOLOCK)
              UNION ALL SELECT 'http://213.74.103.138:1726/IntegratorService/connect'  AS [URL] ,NULL as [TENNANTVALUE]
              UNION ALL SELECT 'http://213.74.103.138:1726/IntegratorService/RunProc'  AS [URL] ,NULL as [TENNANTVALUE]
              UNION ALL SELECT 'http://213.74.103.138:1726/IntegratorService/Post'  AS [URL] ,NULL as [TENNANTVALUE]
              UNION ALL SELECT 'http://213.74.103.138:1726/IntegratorService/disconnect'  AS [URL] ,null as [TENNANTVALUE]

              UNION ALL SELECT CHANNELCONNECTIONURL, NULL FROM EMDS..STDCHANNELMANAGER WITH(NOLOCK) WHERE CHROMEEXTENSION = 1

              GO
              /****** Object:  View [dbo].[VW_ROLE_DETAIL]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO








              CREATE VIEW [dbo].[VW_ROLE_DETAIL]
              AS

                SELECT
              	D.[STDROLEID],D.[MODELNAME],
              	CAST(MAX(CAST(D.PREAD   AS TINYINT)) AS BIT) AS [Select],
              	CAST(MAX(CAST(D.PREAD   AS TINYINT)) AS BIT) AS [Function],
              	CAST(MAX(CAST(D.PNEW    AS TINYINT)) AS BIT) AS [Insert],
              	CAST(MAX(CAST(D.PUPDATE AS TINYINT)) AS BIT) AS [Update],
              	CAST(MAX(CAST(D.PDELETE AS TINYINT)) AS BIT) AS [Delete],
              	CAST(MAX(CAST(D.PEXPORT AS TINYINT)) AS BIT) AS [Export],
              	CAST(MAX(CAST(D.PACTION AS TINYINT)) AS BIT) AS [Execute]
                FROM(
              	---------------------------------------
              	--NORMAL ROLLER AYNI TABLODAN GELECEK--
              	---------------------------------------
              	SELECT D.[STDROLEID],D.[MODELNAME],D.PREAD,D.PNEW,D.PUPDATE,D.PDELETE,D.PEXPORT,D.PACTION
              	FROM EMDS..STDROLE_DETAIL  D WITH(NOLOCK)
              	  WHERE D.[STDROLEID] > 0
              		AND D.[MODELNAME] > ''
              		AND (
              			D.[STDROLEID] IN (12,199)--YA HOTELOWNER OLCAK
              			OR
              			LEFT(D.[MODELNAME],6) NOT IN('STDUSER','STDUSER_HOTELS','STDUSER_ROLES','STDUSER_FIREBASETOKEN')--YA DA TEHLIKELI TABLOLARA ERISMEYECEK !!
              		)

              	UNION ALL
              	-----------------------------------------------------------------------
              	--HOTELOWNER, ICINDE HOTELID GECEN OBJELERIN HEPSINI KURCALAYABILIR..--
              	-----------------------------------------------------------------------
              	SELECT 12,ISNULL(V.[name],T.[name]) AS [MODELNAME],1,1,1,1,1,1
              	FROM EMDS.sys.columns     C
              	LEFT JOIN EMDS.sys.views  V ON V.[object_id] = C.[object_id]
              	LEFT JOIN EMDS.sys.tables T ON T.[object_id] = C.[object_id]
              	WHERE C.[name] = 'HOTELID'
              	  AND (V.[name] > '' OR T.[name] > '')

              	UNION ALL

              	----------------------------------------------------------------------------
              	--HOTELOWNER, ICINDE HOTELID GECEN PARAMETRELERI sp/fn'leri CALISTIRABILIR--
              	----------------------------------------------------------------------------
              	SELECT 12,F.[name],1,1,1,1,1,1
              	FROM EMDS.sys.parameters P
              	INNER JOIN EMDS.sys.objects F ON F.[object_id] = P.[object_id]
              	WHERE P.[name] = '@HOTELID' OR P.[name] = 'HOTELID'

              	UNION ALL
              	------------------------------------------------------------------------------------
              	--2020-07-10:OGUZ EKLEDI CUNKU BIRISI CLOUDPRINTER PROSEDURLERINI KALDIRMIS ROLDEN--
              	------------------------------------------------------------------------------------
              	SELECT R.ID,'SP_EASYPOS_PRINTLIST',1,0,0,0,0,1 FROM EMDS.dbo.STDROLE R
              	UNION ALL
              	SELECT R.ID,'SP_EASYPOS_PRINTDONE',1,0,0,0,0,1 FROM EMDS.dbo.STDROLE R
              	UNION ALL
              	SELECT R.ID,'HOTEL_DEPARTMENT',1,0,0,0,0,0 FROM EMDS.dbo.STDROLE R

                ) D
                GROUP BY D.[STDROLEID],D.[MODELNAME]
              GO
              /****** Object:  Table [dbo].[APISEQUENCEQUEUE]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[APISEQUENCEQUEUE](
              	[ID] [bigint] IDENTITY(1,1) NOT NULL,
              	[CREATETIME_UTC] [datetime] NOT NULL,
              	[URL] [varchar](max) NULL,
              	[STARTTIME_UTC] [datetime] NULL,
              	[FINISHTIME_UTC] [datetime] NULL,
              	[RESULTBODY] [nvarchar](max) NULL,
              	[RESULTHTTPCODE] [smallint] NULL,
              	[REQUESTBODY] [nvarchar](max) NULL,
              	[REQUESTCONTENTTYPE] [varchar](100) NULL,
              PRIMARY KEY CLUSTERED
              (
              	[ID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[CONFIG]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[CONFIG](
              	[KEY] [nvarchar](100) NOT NULL,
              	[VALUE] [nvarchar](max) NOT NULL,
              	[CREATEDATE] [datetime] NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[KEY] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[CONFIG_PUBLISH]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[CONFIG_PUBLISH](
              	[ID] [int] IDENTITY(1,1) NOT NULL,
              	[NOTE] [nvarchar](50) NULL,
              	[WHEN] [datetime] NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[ID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[IP_HOTEL]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[IP_HOTEL](
              	[IPADDRESS] [varchar](15) NOT NULL,
              	[HOTELID] [int] NOT NULL,
              	[USERID] [int] NULL,
              	[FIRSTACCESS] [datetime] NULL,
              	[LASTACCESS] [datetime] NULL,
              PRIMARY KEY CLUSTERED
              (
              	[IPADDRESS] ASC,
              	[HOTELID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[IP_WHITELIST]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[IP_WHITELIST](
              	[IPADDRESS] [varchar](15) NOT NULL,
              	[ALLOWUNTIL] [datetime] NOT NULL,
              	[NOTES] [nvarchar](100) NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[IPADDRESS] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[LOG_OLD]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[LOG_OLD](
              	[ID] [int] IDENTITY(1,1) NOT NULL,
              	[ACTION] [varchar](11) NULL,
              	[OBJECT] [nvarchar](100) NULL,
              	[LOGTIMEUTC] [datetime] NOT NULL,
              	[IPADDRESS] [varchar](20) NULL,
              	[BODY] [nvarchar](max) NULL,
              	[ROWID] [nvarchar](100) NULL,
              	[HOTELID] [int] NULL,
              	[DURATION] [int] NULL,
              	[HTTPCODE] [smallint] NULL,
              	[REQUESTOBJECT]  AS (case when [ACTION]='Execute' AND isjson([BODY])=(1) then isnull(json_value([BODY],'$."$Procedure"'),[OBJECT]) else [OBJECT] end),
              	[USERID] [varchar](100) NULL,
              PRIMARY KEY CLUSTERED
              (
              	[ID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[LOGSUMMARY]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[LOGSUMMARY](
              	[HOTELID] [int] NOT NULL,
              	[USER] [nvarchar](100) NOT NULL,
              	[OBJECT] [nvarchar](100) NOT NULL,
              	[Select] [int] NOT NULL,
              	[Insert] [int] NOT NULL,
              	[Update] [int] NOT NULL,
              	[Delete] [int] NOT NULL,
              	[Execute] [int] NOT NULL,
              	[ApiSequence] [int] NOT NULL,
              	[Function] [int] NOT NULL,
              	[SetConfig] [int] NOT NULL,
              	[Login] [int] NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[HOTELID] ASC,
              	[USER] ASC,
              	[OBJECT] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[MANUELSCRIPTS]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[MANUELSCRIPTS](
              	[ID] [int] IDENTITY(1,1) NOT NULL,
              	[SCRIPT] [nvarchar](max) NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[ID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[RUNNINGPROCESS]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[RUNNINGPROCESS](
              	[HOSTNAME] [nvarchar](50) NOT NULL,
              	[HOSTPID] [int] NOT NULL,
              	[LASTREPORT_UTC] [datetime] NULL,
              	[ISNETWORKMASTER] [bit] NULL,
              	[ISMACHINEMASTER] [bit] NULL,
              PRIMARY KEY CLUSTERED
              (
              	[HOSTNAME] ASC,
              	[HOSTPID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[TEMP]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[TEMP](
              	[KEY] [nvarchar](250) NOT NULL,
              	[VALUE] [nvarchar](max) NULL,
              	[DATE] [datetime] NOT NULL,
              PRIMARY KEY CLUSTERED
              (
              	[KEY] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[USER2FA]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[USER2FA](
              	[USERID] [varchar](50) NOT NULL,
              	[SMSCODE] [varchar](6) NULL,
              	[VALIDUNTIL_UTC] [datetime] NULL,
              PRIMARY KEY CLUSTERED
              (
              	[USERID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              ) ON [PRIMARY]
              GO
              /****** Object:  Table [dbo].[USERSHASH]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TABLE [dbo].[USERSHASH](
              	[CURRENTHASH] [varchar](200) NULL
              ) ON [PRIMARY]
              GO
              SET ANSI_PADDING ON
              GO
              /****** Object:  Index [CIX_CURRENTHASH]    Script Date: 17.08.2021 4:34:35 PM ******/
              CREATE CLUSTERED INDEX [CIX_CURRENTHASH] ON [dbo].[USERSHASH]
              (
              	[CURRENTHASH] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              GO
              /****** Object:  Index [IX_HOTELID]    Script Date: 17.08.2021 4:34:35 PM ******/
              CREATE NONCLUSTERED INDEX [IX_HOTELID] ON [dbo].[LOG_OLD]
              (
              	[HOTELID] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              GO
              SET ANSI_PADDING ON
              GO
              /****** Object:  Index [IX_LOG]    Script Date: 17.08.2021 4:34:35 PM ******/
              CREATE NONCLUSTERED INDEX [IX_LOG] ON [dbo].[LOG_OLD]
              (
              	[OBJECT] ASC,
              	[ROWID] ASC
              )WITH (PAD_INDEX = ON, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 50, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              GO
              /****** Object:  Index [IX_LOGTIME]    Script Date: 17.08.2021 4:34:35 PM ******/
              CREATE NONCLUSTERED INDEX [IX_LOGTIME] ON [dbo].[LOG_OLD]
              (
              	[LOGTIMEUTC] ASC
              )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              GO
              /****** Object:  Index [IX_LOGTIME SELECT/FUNCTION]    Script Date: 17.08.2021 4:34:35 PM ******/
              CREATE NONCLUSTERED INDEX [IX_LOGTIME SELECT/FUNCTION] ON [dbo].[LOG_OLD]
              (
              	[LOGTIMEUTC] ASC
              )
              WHERE ([ACTION] IN ('Select', 'Function'))
              WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
              GO
              ALTER TABLE [dbo].[APISEQUENCEQUEUE] ADD  DEFAULT (getutcdate()) FOR [CREATETIME_UTC]
              GO
              ALTER TABLE [dbo].[CONFIG] ADD  DEFAULT (getutcdate()) FOR [CREATEDATE]
              GO
              ALTER TABLE [dbo].[CONFIG_PUBLISH] ADD  DEFAULT (getutcdate()) FOR [WHEN]
              GO
              ALTER TABLE [dbo].[IP_WHITELIST] ADD  DEFAULT (dateadd(day,(1),getutcdate())) FOR [ALLOWUNTIL]
              GO
              ALTER TABLE [dbo].[LOG_OLD] ADD  DEFAULT (getutcdate()) FOR [LOGTIMEUTC]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Select]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Insert]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Update]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Delete]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Execute]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [ApiSequence]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Function]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [SetConfig]
              GO
              ALTER TABLE [dbo].[LOGSUMMARY] ADD  DEFAULT ((0)) FOR [Login]
              GO
              ALTER TABLE [dbo].[TEMP] ADD  DEFAULT (getutcdate()) FOR [DATE]
              GO
              ALTER TABLE [dbo].[IP_WHITELIST]  WITH CHECK ADD  CONSTRAINT [Notlara en az 10 karakter girmek zorundasiniz] CHECK  ((len([NOTES])>(10)))
              GO
              ALTER TABLE [dbo].[IP_WHITELIST] CHECK CONSTRAINT [Notlara en az 10 karakter girmek zorundasiniz]
              GO
              /****** Object:  StoredProcedure [dbo].[SP_AFTERLOGIN]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO





              CREATE PROCEDURE [dbo].[SP_AFTERLOGIN]
                    @USERID    NVARCHAR(50),
                    @TENANTID  NVARCHAR(50),
                    @IPADDRESS VARCHAR(45) = NULL,
                    @USERAGENT VARCHAR(150) = NULL,
                    @IPCOUNTRY NVARCHAR(2) = NULL
                AS


                DECLARE @YEDEK30 BIT = CASE WHEN @@SERVERNAME = 'WIN-9K0D3H2Q085' THEN 1 ELSE 0 END
                DECLARE @EMDS_LASTRESTORE NVARCHAR(50)

                IF @YEDEK30 = 1
                BEGIN
                    DECLARE @OFFSET INT,@OFFSETSTR NVARCHAR(50)
                    SELECT @OFFSET = HOUROFFSET,@OFFSETSTR = Z.[NAME]
                    FROM EMDS..HOTEL H WITH(NOLOCK)
                    INNER JOIN EMDS..STDTIMEZONE Z WITH(NOLOCK) ON Z.ID = ISNULL(H.TIMEZONEID,16)
                    WHERE H.ID = @TENANTID

                    SELECT  @EMDS_LASTRESTORE = FORMAT(MAX(DATEADD(HOUR,@OFFSET,[bs].[backup_finish_date])),'dd MMMM HH:mm') + @OFFSETSTR
                    FROM    msdb..restorehistory rs
                            INNER JOIN msdb..backupset bs ON [rs].[backup_set_id] = [bs].[backup_set_id]
                            INNER JOIN msdb..backupmediafamily bmf ON [bs].[media_set_id] = [bmf].[media_set_id]
                    WHERE rs.[destination_database_name]='EMDS'

                END

                --2020-07-10 13:42 UTC'DE OGUZ KAPATTI
                --INSERT INTO STDUSER_LOGIN(LOGINTIME,LOGINID,HOTELID)VALUES(DATEADD(HOUR,3,GETUTCDATE()),@USERID,@TENANTID )

                DECLARE @TAWKTOAPIKEY varchar(MAX) = '41b70f59f97ed3aab3302ea9562ad53234188f9a'
                DECLARE @USERINTID INT = TRY_PARSE(@USERID AS INT)
                DECLARE @ADMINDEFAULTTENANT INT
                DECLARE @HOTELADMINLEVEL INT = (SELECT TOP(1) ADMINLEVEL FROM EMDS.dbo.VW_HOTEL WHERE HOTELID = @TENANTID)
                DECLARE @USERADMINLEVEL  INT

                IF @USERINTID < 0
                BEGIN
                    DECLARE @REFCODE VARCHAR(10)

                    SELECT TOP(1)
                        @USERADMINLEVEL=ADMINLEVEL ,
                        @ADMINDEFAULTTENANT = EASYPMSTENANT,
                        @REFCODE = REFCODE
                    FROM ERSDEVELOPER..ANGUSDEVELOPER WITH(NOLOCK)
                    WHERE ID = @USERINTID

                    --2021-06-30:OGUZ:BAYILER ICIN "KENDI OTELI MI ??" KONTROLU..
                    IF LEN(@REFCODE)>0 AND @USERADMINLEVEL = 99
                    BEGIN
                        IF NOT EXISTS(SELECT TOP(1) 1 FROM EMDS..HOTEL WITH(NOLOCK) WHERE ID = @TENANTID AND REFCODE = @REFCODE AND ADMINLEVEL <= @USERADMINLEVEL)
                            THROW 51000,'You are not allowed to connect to this hotel',1
                    END
                END

                IF @USERINTID < 0 AND @HOTELADMINLEVEL > @USERADMINLEVEL AND @TENANTID <> @ADMINDEFAULTTENANT
                  THROW 51000,'Your admin level is not suitable to impersonate this hotel, please consult Can Temizkan',1

                --2019-03-21:OGUZ:LOGIN OLMUS OTELIN PORTALID'SI OTOMATIK DOLMALI ISTEKLERDE !!!
                SELECT TOP(1)
                    @REFCODE AS [REFCODE],
                    'https://{{ .Values.reporting.host }}/Print' AS REPORTURL,

                    --CASE WHEN @TENANTID IN ('18892','20854 ') OR RIGHT(@TENANTID,1) IN ('0','1','2','3') THEN 'wss://4001std-v3.azurewebsites.net/' END
                    CASE
                        WHEN H.ID =  21878 THEN 'https://4001kk.hoteladvisor.net/'
                        WHEN @USERINTID < 0 THEN NULL--2021-04-06:OGUZ:ADMINLER HEP DUZ POST ILE CALISSIN
                        WHEN (H.ID in (21907,21878,22225,21192,20846,21713 ) ) THEN NULL --AKRONES DENEME
                        WHEN H.ID IN(20292,21392,21713,22191) AND NOT EXISTS(SELECT TOP(1) 1 FROM [ENDPOINT] E WITH(NOLOCK) WHERE E.TENANTID = @TENANTID AND E.[URL]>'') THEN 'wss://4001.hoteladvisor.net'--'wss://4001docker.azurewebsites.net'
                        WHEN CHARINDEX('Windows NT 6.1',@USERAGENT) > 0 THEN 'wss://4001.hoteladvisor.net'--2021-03-04:OGUZ/TOLGA:WINDOWS 7'LER WEBSOCKET KULLANSIN, CUNKU ONLAR PAKET YOLLAYIP CANCEL EDEMEYEBILIYOR
                        ELSE NULL
                    END AS WEBSOCKETURL,
                    (SELECT MAX(ID) FROM CONFIG_PUBLISH WITH(NOLOCK)) AS CONFIGVERSION,
                    CONVERT(NVARCHAR(200),HASHBYTES('MD5',CAST(PINCODE AS VARCHAR(4))),2) AS PINHASH,
                    CASE
                        WHEN @USERINTID < 0 AND @USERINTID <> -15/*KORAL*/ THEN 15
                        WHEN U.[2FASTATE] IN(3,4) AND U.[2FAKEY] > ''      THEN 60
                        ELSE 999999 END AS IDLELOGOUTMINUTES,
                    H.GENDARMEDEFAULTID,
                    H.SUBDOMAIN,
                    H.INTERNALCHATENABLED,--2019-06-17:OGUZ/TOLGA
                    U.INTERNALCHATUSERNAME,--2019-06-17:OGUZ/TOLGA
                    U.INTERNALCHATPASSWORD,--2019-06-17:OGUZ/TOLGA
                    U.STDUSERDEPID,
                    U.CHIEFOFSTOREID ,
                    U.NEEDAPPROVALFORPURCHASE,
                    U.MAIDCHEF,
                    U.USERCODE,
                    U.NATIONALIDNO,
                    U.KBS2FASECRET,
                    H.DOORKEYCARDMODE,
                    H.EMAIL AS TENANTEMAIL,
                    H.[PHONE] AS TENANTPHONE,
                    H.[NAME] AS TENANTNAME,
                    H.LOGOURL AS TENANTLOGOURL,
                    H.[ADDRESS] AS TENANTADDRESS,
                    H.WEB AS [TENANTWEB],
                    H.DEFAULTCASHDEPARTMENTID AS DEFAULTCASHDEPARTMENTID,
                    DEPT.[DEPARTMENTNAME] DEFAULTCASHDEPARTMENT,
                    C.ID AS [DEFAULTCURRENCYID],
                    C.CODE3 AS [DEFAULTCURRENCY],
                    PC.ID AS [POSCURRENCYID],
                    PC.CODE3 AS [POSCURRENCY],

                    --2020-01-10:OGUZ:RATEMANAGER ICIN
                    OC.ID AS [RATECURRENCYID],
                    OC.CODE3 AS [RATECURRENCYCODE],

                    H.[PORTALID],/*CAST(H.PROGDATE AS DATE)*/convert(nvarchar(10),H.PROGDATE,121) AS PROGDATE,
                    --master.[sys].[fn_varbintohexstr](HASHBYTES('SHA2_256', cast(@USERID as nvarchar)/*U.USERCODE*/ + @TAWKTOAPIKEY)) AS [TAWKTOUSERCODE]

                    REPLACE(master.[sys].[fn_varbintohexstr]( dbo.HMAC('SHA2_256',@TAWKTOAPIKEY, H.[EMAIL] )),'0x','') AS [TAWKTOUSERCODE],

                    CONVERT(NVARCHAR(5),ISNULL(H.CHECKINTIME,'14:00'),114) AS CHECKINTIME,
                    CONVERT(NVARCHAR(5),ISNULL(H.CHECKOUTTIME,'11:00'),114) AS CHECKOUTTIME,

                    --2021-10-07:OGUZ:TRANSLATOR TABLOSUNA EKLI INSANLAR GIRINCE MENUDE TRANSLATE MENUSU CIKABILSIN
                    ISNULL((SELECT TOP(1) 'Translator,' FROM EMDS..TRANSLATORS TU WITH(NOLOCK) WHERE TU.TRANSLATORUSERID = U.ID),'')+
                    ISNULL(R.ROLENAME,'')+ISNULL((
                                                     SELECT ','+R.ROLENAME+ISNULL(','+R.ROLECODE,'')
                                                     FROM EMDS..STDUSER_ROLES UR WITH(NOLOCK)
                                                              INNER JOIN EMDS..STDROLE  R WITh(NOLOCK) ON R.ID = UR.ROLEID
                                                     WHERE UR.USERID = U.ID
                                                           FOR XML PATH('')
                                                 ),'') AS [ALLROLES],

                    'SP_EASYPMS_TENANTCHANGED' AS TENANTCHANGEDSP,

                    CASE WHEN 1=ISNULL(SUBS.MODULE_POS,0)THEN 'EASYPOS' ELSE 'QUICKPOS' END AS [POSMODE],

                    ISNULL(STUFF((
                        SELECT ','+S.CODE2
                        FROM EMDS..PORTAL_LANGUAGES L WITH(NOLOCK)
                        INNER JOIN EMDS..[LANGUAGE] S WITH(NOLOCK) ON S.[LANGUAGEID] = L.LANGUAGEID
                        WHERE L.HOTELID = H.ID
                          AND L.ISACTIVE = 1
                        FOR XML PATH('')
                    ),1,1,''),'') AS LANGUAGES,

                    STUFF((SELECT ','+CAST(BRANCHID AS NVARCHAR(14)) FROM EMDS..STDUSER_BRANCH B WITH(NOLOCK) WHERE B.USERID = @USERID FOR XML PATH('') ),1,1,'') AS BRANCHIDS,
                    ISNULL(UB.BRANCHID,AB.ID) AS DEFAULTBRANCHID,
                    UBN.NAME AS DEFAULTBRANCH,

                    --2021-05-18:TEOMAN, KULLANICILARA DEPO SINIRLAMALARI GETIRDIK
                    STUFF((SELECT ','+CAST(STOREID AS NVARCHAR(14)) FROM EMDS..STDUSER_STORE S WITH(NOLOCK) WHERE S.USERID = @USERID FOR XML PATH('') ),1,1,'') AS STOREIDS,
                    US.STOREID  AS DEFAULTSTOREID,
                    USTORE.NAME AS DEFAULTSTORE,

                    H.DEFAULTLANGUAGE,
                    'webhotel'AS ONLYAPPLICATION,--STDROLE BICILEBILSIN DIYE

                    H.KBSMODE,
                    H.KBSCODE,
                    H.KBSPASSWORD,
                    H.KBSAUTO,

                    OCC.CODE3 AS ONLINECURRENCYCODE,
                    H.ONLINECURRENCYID,
                    H.ONLINEAGENCYID,
                    A.RATECODEID AS ONLINERATECODEID,
                    A.AGENCYCODE AS ONLINEAGENCYCODE,
                    A.RATETYPEID AS DEFAULTRATETYPEID,
                    A.BOARDID AS DEFAULTBOARDTYPEID,
                    BT.BOARDTYPE AS DEFAULTBOARDTYPE,
                    RT.CODE AS DEFAULTRATETYPE,
                    RC.RATECODE AS ONLINERATECODE,

                    CONVERT(NVARCHAR(MAX),(
                        SELECT *
                        FROM(
                            --SELECT /*@TENANTID*/U0.HOTELID AS TENANTID,NULL AS APIURL,H0.[NAME] AS DISPLAYNAME,'Default' as [key] ,H0.[NAME] as [displayField],-1 AS DISPLAYORDER
                            --FROM EMDS..STDUSER U0 WITH(NOLOCK)
                            --INNER JOIN EMDS..HOTEL H0 WITH(NOLOCK) ON H0.ID = U0.HOTELID
                            --WHERE U0.ID = @USERID
                            SELECT /*@TENANTID*/U0.HOTELID AS TENANTID,NULL AS APIURL,H0.[NAME] AS DISPLAYNAME,'Default' as [key] ,H0.[NAME] as [displayField],-1 AS DISPLAYORDER
                            FROM EMDS..STDUSER U0 WITH(NOLOCK)
                            LEFT  JOIN EMDS..STDUSER_HOTELS CHILD WITH(NOLOCK) ON CHILD.SUBUSERID = @USERID
                            LEFT  JOIN EMDS..STDUSER PARENT WITH(NOLOCK) ON PARENT.ID = CHILD.STDUSERID
                            INNER JOIN EMDS..HOTEL H0 WITH(NOLOCK) ON H0.ID = ISNULL(PARENT.HOTELID,U0.HOTELID)
                            WHERE U0.ID = @USERID

                            UNION ALL

                            --DOGRUDAN BENIM COCUKLARIM
                            select
                                AU.TENANTID,
                                AU.APIURL,
                                AU.DISPLAYNAME,
                                AU.DISPLAYNAME AS [key],
                                AU.DISPLAYNAME AS [displayField],
                                cast(AU.DISPLAYORDER as smallint)
                            FROM EMDS..[STDUSER_HOTELS] AU WITH(NOLOCK)
                            WHERE AU.STDUSERID = @USERID

                            UNION ALL

                            --DOGRUDAN KARDESLERIM
                            select
                                SB.TENANTID,
                                SB.APIURL,
                                SB.DISPLAYNAME,
                                SB.DISPLAYNAME AS [key],
                                SB.DISPLAYNAME AS [displayField],
                                cast(SB.DISPLAYORDER as smallint)
                            FROM EMDS..[STDUSER_HOTELS] AU WITH(NOLOCK)
                            INNER JOIN EMDS..[STDUSER_HOTELS] SB WITH(NOLOCK) ON SB.STDUSERID = AU.STDUSERID
                            WHERE AU.SUBUSERID = @USERID
                        )AS TBL
                        ORDER BY TBL.DISPLAYORDER ASC
                        FOR JSON AUTO
                    )) AS APIKEYS,

                    --2019-12-18:OGUZ/KEMAL:HESAPLARIN ODEMELERINI HIZLICA ALABILMEK ICIN
                    H.ACCOUNTID_MAINSAFE,
                    V1.NAME AS ACCOUNT_MAINSAFE,
                    H.ACCOUNTID_CREDITCARD,
                    V2.NAME AS ACCOUNT_CREDITCARD,
                    H.[ACCOUNTID_BANK],
                    V3.NAME AS[ACCOUNT_BANK],

                    CAST(case when EXISTS(SELECT TOP(1) 1 FROM EMDS..EFATURA_SUPPLIER S WITH(NOLOCK) WHERE S.HOTELID = @TENANTID AND S.TaxNumber LIKE '%[0-9]%') THEN 1 ELSE 0 END AS BIT) AS EINVOICEENABLED,

                  U.USEREMINDER,
                  --2020-03-04:OGUZ
                  (SELECT COUNT(H2.ID) FROM EMDS..HOTEL H2 WITH(NOLOCK) WHERE H2.ID = H.ID OR H2.GROUPID = H.GROUPID) AS GROUPHOTELCOUNT,

                  --2020-06-12:OGUZ
                  H.POSVERSION,

                  SUBS.MODULE_PMSMINI,
                  SUBS.MODULE_PMSMODE,

                  SUBS.STOP_IF_OVERDUEPAYMENT,

                  CASE
                    WHEN @YEDEK30 = 1
                    THEN '<div style="width: 100%; background-color: #f44336; color: rgba(255,255,255,.84); text-align: center;padding: 5px;display: flex;justify-content: center;align-items: center;">'+
                         '<mat-icon class="material-icons">warning</mat-icon>'+
                         'Elektraweb Backup '+@EMDS_LASTRESTORE+
                         '</div>'

                    --WHEN @TENANTID <> '18892' THEN NULL
                    WHEN SUBS.OVERDUEPAYMENT > 0 OR SUBS.DISPLAYMESSAGE > '' OR SUBS.DEMOMODE = 1
                    THEN '<div style="width: 100%; background-color: #f44336; color: rgba(255,255,255,.84); text-align: center;padding: 5px;display: flex;justify-content: center;align-items: center;">'+
                         '<mat-icon class="material-icons">warning</mat-icon>'+

                         ISNULL(NULLIF(SUBS.DISPLAYMESSAGE,'')+' ','')+
                         CASE WHEN SUBS.OVERDUEPAYMENT > 0  OR SUBS.DEMOMODE = 1
                         THEN
                             '<a  style="margin: 0 10px;color: rgba(255,255,255,.87);" href="javascript:((()=>{ angus.ngZone.run(()=>{ var l = angus.loadingService.showLoadingOverlay(); angus.router.navigate([''/app/hotel/payment'']).then(()=>l.destroy()) }) })())" >'+
                                CASE WHEN ISNULL(SUBS.DEMOMODE,0) = 1 THEN 'Demo Mode ' ELSE '' END+
                                CASE WHEN SUBS.OVERDUEPAYMENT > 0 THEN
                                    CASE WHEN H.DEFAULTLANGUAGE = 'TR'
                                    THEN 'Lisans aktivasyonu iin tklaynz'
                                    ELSE 'Click here to activate your licence'END
                                ELSE '' END+
                             '</a>'
                         ELSE '' END+
                         '<mat-icon class="material-icons" style="font-size: 14px;position: relative;top: 2px;">launch</mat-icon></div>'

                    --WHEN LEFT(@USERID,1)='-'  THEN '<b>Adminsiniz lutfen dikkatli olunuz</b>'

                  end


                  AS HTMLDISPLAYMESSAGE,

                  --2020-06-23:OGUZ
                  CAST(CASE WHEN SUBS.DEMOMODE = 1 AND SUBS.[STARTDATE] < DATEADD(MONTH,-1,GETDATE()) THEN 1 ELSE 0 END AS BIT) AS DEMOOVER,

                  --2020-05-26:OGUZ:HOTELSETTINGS
                  H.ROOMCAPACITY,
                  H.BEDCAPACITY,
                  --CASE WHEN H.ID = 19544 THEN null --OGUZ:https://sp.ersas.com sitesi de 4001'i kullandigi iin ora bozulmasn diye
                     --  WHEN @@SERVERNAME <> 'DB' THEN null--OGUZ:Diger yedek30/yedek24 gibi sunucularda redirection olmasin diye
                     --  WHEN SUBS.MODULE_PMSMODE = 2 THEN 'midi'
                     --  WHEN SUBS.MODULE_PMSMODE = 3 THEN 'mini'
                     --  ELSE 'app'
                  --END AS REDIRECTURL,
                  CASE WHEN H.ID = 19544 THEN null --OGUZ:https://sp.ersas.com sitesi de 4001'i kullandigi iin ora bozulmasn diye
                       WHEN @@SERVERNAME <> 'elektraweb1.558ea2690441.database.windows.net' THEN null--OGUZ:Diger yedek30/yedek24 gibi sunucularda redirection olmasin diye
                       WHEN SUBS.MODULE_PMSMODE = 0 THEN 'NonPms'
                       WHEN SUBS.MODULE_PMSMODE = 2 THEN 'Midi'
                       WHEN SUBS.MODULE_PMSMODE = 3 THEN 'Mini'
                       ELSE ''
                  END AS PACKAGENAME,
                  U.TASKVIEWMODE,U.MAID,

                  STORE.ID   AS MAINSTOREID,--2020-12-03:OGUZ
                  STORE.[NAME] AS MAINSTORE,--2020-12-03:OGUZ

                  U.MAXDISCOUNTPERCENT,
                  ISNULL(U.[FIRSTNAME],'') + ISNULL(' ' + U.LASTNAME,'') AS [USERNAME],
                  U.PHONE AS USERPHONE,
                  U.EMAIL AS USEREMAIL,
                  U.POSITION AS USERPOSITION,
                  Z.HOUROFFSET AS TIMEZONE_HOUROFFSET,
                  Z.NAME AS TIMEZONE_NAME,

                  ADR.[NAME] AS ADDRESS_NAME,
                  [AS].USESUBACCOUNT                        AS ACCOUNTING_USESUBACCOUNT,
                  [AS].LOCKINVOICEOFDESPATCH                AS ACCOUNTING_LOCKINVOICEOFDESPATCH,
                  [AS].CHECKLASTSTOCKBALANCE                AS ACCOUNTING_CHECKLASTSTOCKBALANCE,
                  [AS].ALLOWCHANGE_STOCKINVOICEACCRECEIPT   AS ACCOUNTING_ALLOWCHANGE_STOCKINVOICEACCRECEIPT  ,
                  [AS].ALLOWCHANGE_SERVICEINVOICEACCRECEIPT	AS ACCOUNTING_ALLOWCHANGE_SERVICEINVOICEACCRECEIPT,
                  [AS].ALLOWCHANGE_HOTELINVOICEACCRECEIPT	AS ACCOUNTING_ALLOWCHANGE_HOTELINVOICEACCRECEIPT  ,
                  [AS].ALLOWCHANGE_STOCKFICHEACCRECEIPT		AS ACCOUNTING_ALLOWCHANGE_STOCKFICHEACCRECEIPT	  ,
                  [AS].ALLOWCHANGE_COUNTINGACCRECEIPT		AS ACCOUNTING_ALLOWCHANGE_COUNTINGACCRECEIPT	  ,
                  [AS].ALLOWCHANGE_PAYROLLACCRECEIPT		AS ACCOUNTING_ALLOWCHANGE_PAYROLLACCRECEIPT  	  ,
                  [AS].RECEIPTNUMBER_MANUAL,--2021-02-25:AHMET
                  [AS].ENABLE_EFATURASUPPLIER_ONINVOICEFORM, --2021-05-27:TEOMAN, user bazl seri kullanm
                  [AS].QUICKINVOICE_PASSERBYCASH_ACCOUNTID,  --2021-06-18:TEOMAN, Hzl fatura pein carisi
                  [AS].SENDPAYMENTLINK_INRECONCILIATIONEMAIL,--2021-10-19:TEOMAN, Mutabakatta deme linki gndermek iin
                  AS_AV1.NAME AS QUICKINVOICE_PASSERBYCASH_ACCOUNT,--2021-06-23:TEOMAN, Hzl fatura pein carisinin ad
                  [AS].DONTSHOW_ACCOUNT_BALANCES_INACCOUNTLIST AS ACCOUNTING_DONTSHOW_ACCOUNT_BALANCES_INACCOUNTLIST, --2021-08-26:TEOMAN, hesap planinda sube ve tarih secimli balans gosterim
                  --2021-03-11:OGUZ:KEMAL BEY DEDI
                  ES.[ACCOUNTING_EMAIL],
                  ES.[PURCHASING_EMAIL],
                  ES.[FRONTOFFICE_EMAIL],
                  ES.[BABS_EMAIL],
                  ES.[CALLCENTER_EMAIL],

                  --2021-05-26:OGUZ
                  RESC.AGEINTERVAL1 AS RES_DEFAULTRATECODEID_AGEINTERVAL1,
                  RESC.AGEINTERVAL2 AS RES_DEFAULTRATECODEID_AGEINTERVAL2,
                  RESC.AGEINTERVAL3 AS RES_DEFAULTRATECODEID_AGEINTERVAL3,
                  RESB.BOARDTYPE    AS RES_DEFAULTBOARDTYPE,
                  RESC.RATECODE     AS RES_DEFAULTRATECODE,
                  RESCUR.CODE3      AS RES_DEFAULTCURRENCY,
                  RESG.[NAME]       AS RES_DEFAULTSEGMENT,
                  RESK.[SOURCE]     AS RES_DEFAULTSOURCE,
                  RESO.ROOMTYPECODE AS RES_DEFAULTROOMTYPE,
                  RESU.[NAME]       AS RES_DEFAULTNATION,
                  RESF.CODE         AS RES_DEFAULTRATETYPE,

                  --2021-08-20:OGUZ/HAYDAR:USER'DAN GELEN KBS'YI EZMESIN YANLISLIKLA DIYE AYRI KOLON ISMIYLE YOLLADIK
                  HS.KBS2FASECRET AS HS_KBS2FASECRET,
                  HS.KBSTCKN AS HS_KBSTCKN,

                  --SOURCE
                  HS.*


                FROM EMDS..HOTEL H WITH(NOLOCK)
                LEFT JOIN EMDS..HOTEL_EMAIL_SETTINGS ES WITH(NOLOCK) ON ES.HOTELID = H.ID
                LEFT JOIN EMDS..HOTEL_DEPARTMENT DEPT WITH(NOLOCK) ON DEPT.ID = H.DEFAULTCASHDEPARTMENTID
                LEFT JOIN EMDS..STDUSER U WITH(NOLOCK) ON U.ID = @USERID
                LEFT JOIN EMDS..STDROLE R WITH(NOLOCK) ON R.ID = U.ROLEID
                LEFT JOIN EMDS..STDCURCODE C WITH(NOLOCK) ON C.ID = H.DEFAULTCURRENCYID
                LEFT JOIN ERSDEVELOPER..ANGUSDEVELOPER D WITH(NOLOCK) ON D.ID = @USERID
                LEFT JOIN EMDS..AGENCY A WITH(NOLOCK) ON A.ID = H.ONLINEAGENCYID
                LEFT JOIN EMDS..HOTEL_BOARDTYPE BT WITH(NOLOCK) ON BT.ID = A.BOARDID
                LEFT JOIN EMDS..HOTEL_RATETYPE RT WITH(NOLOCK) ON RT.ID = A.RATETYPEID
                LEFT JOIN EMDS..HOTEL_RATECODE RC WITH(NOLOCK) ON RC.ID = A.RATECODEID

                LEFT JOIN EMDS..STDCURCODE OC WITH(NOLOCK) ON OC.ID = RC.CURRENCYID
                LEFT JOIN EMDS..STDCURCODE PC WITH(NOLOCK) ON PC.ID = H.POSCURRENCYID

                LEFT JOIN EMDS..APPCARD_VIRTUAL V1 WITH(NOLOCK) ON V1.ID = H.ACCOUNTID_MAINSAFE
                LEFT JOIN EMDS..APPCARD_VIRTUAL V2 WITH(NOLOCK) ON V2.ID = H.ACCOUNTID_CREDITCARD
                LEFT JOIN EMDS..APPCARD_VIRTUAL V3 WITH(NOLOCK) ON V3.ID = H.[ACCOUNTID_BANK]

                LEFT JOIN EMDS..STDCURCODE OCC WITH(NOLOCK) ON OCC.ID = H.ONLINECURRENCYID
                LEFT JOIN EMDS..HOTEL_SETTINGS HS WITH(NOLOCK) ON HS.HOTELID = H.ID
                OUTER APPLY(
                    SELECT TOP(1) *
                    FROM EMDS..HOTEL_SUBSCRIPTION SUBS WITH(NOLOCK)
                    WHERE SUBS.OTELID = H.ID
                        --AND CAST(GETDATE() AS DATE) BETWEEN SUBS.STARTDATE AND SUBS.ENDDATE
                    ORDER BY SUBS.ENDDATE desc--SUBS.ID DESC
                )SUBS
                LEFT JOIN EMDS..STDTIMEZONE Z WITH(NOLOCK) ON Z.ID = H.TIMEZONEID
                LEFT JOIN EMDS..ACCOUNTING_BRANCH AB WITH(NOLOCK) ON AB.HOTELID = H.ID AND AB.ISDEFAULT = 1
                LEFT JOIN EMDS..STDUSER_BRANCH UB  WITH(NOLOCK) ON UB.USERID = @USERID AND UB.ISDEFAULT = 1
                LEFT JOIN EMDS..STDUSER_STORE  US  WITH(NOLOCK) ON US.USERID = @USERID AND US.ISDEFAULT = 1           	--2021-05-18:TEOMAN, KULLANICILARA DEPO SINIRLAMALARI GETIRDIK
                LEFT JOIN EMDS..STOCK_STORE USTORE WITH(NOLOCK) ON USTORE.HOTELID = H.ID AND USTORE.ID = US.STOREID     --2021-05-18:TEOMAN, KULLANICILARA DEPO SINIRLAMALARI GETIRDIK
                LEFT JOIN EMDS..STOCK_STORE STORE  WITH(NOLOCK) ON STORE.HOTELID = H.ID AND STORE.MAINSTORE = 1
                                                                                                AND STORE.BRANCHID = ISNULL(UB.BRANCHID,AB.ID) --2021-03-27:TEOMAN
                LEFT JOIN EMDS..ACCOUNTING_BRANCH UBN WITH(NOLOCK) ON UBN.ID = ISNULL( UB.BRANCHID,AB.ID )
                LEFT JOIN EMDS..[ADDRESS] ADR WITH(NOLOCK) ON ADR.ID = H.ADDRESSID

                LEFT JOIN EMDS..ACCOUNTING_SETTINGS [AS] WITH(NOLOCK) ON [AS].HOTELID = H.ID
                LEFT JOIN EMDS..APPCARD_VIRTUAL   AS_AV1 WITH(NOLOCK) ON AS_AV1.ID = [AS].QUICKINVOICE_PASSERBYCASH_ACCOUNTID

                LEFT JOIN EMDS..HOTEL_RATECODE RESC WITH(NOLOCK) ON RESC.ID = HS.RES_DEFAULTRATECODEID
                LEFT JOIN EMDS..HOTEL_BOARDTYPE RESB WITH(NOLOCK) ON RESB.ID = HS.RES_DEFAULTBOARDTYPEID
                LEFT JOIN EMDS..STDCURCODE RESCUR WITH(NOLOCK) ON RESCUR.ID = HS.RES_DEFAULTCURRENCYID
                LEFT JOIN EMDS..HOTEL_SEGMENT RESG WITH(NOLOCK) ON RESG.ID = HS.RES_DEFAULTSEGMENTID
                LEFT JOIN EMDS..HOTEL_SOURCE RESK WITH(NOLOCK) ON RESK.ID = HS.RES_DEFAULTSOURCEID
                LEFT JOIN EMDS..HOTEL_ROOMTYPE RESO WITH(NOLOCK) ON RESO.ID = HS.RES_DEFAULTROOMTYPEID
                LEFT JOIN EMDS..COUNTRY RESU WITH(NOLOCK) ON RESU.ID = HS.RES_DEFAULTNATIONID
                LEFT JOIN EMDS..HOTEL_RATETYPE RESF WITH(NOLOCK) ON RESF.ID = HS.RES_DEFAULTRATETYPEID
                WHERE H.ID = TRY_PARSE(@TENANTID AS INT)


                ---------------------------------------------------
                --2020-08-17:OGUZ:GELEN PARAMETRELERI GORMEK ICIN--
                ---------------------------------------------------
                SELECT @TENANTID AS TENANTID,@USERID AS [USERID]

                DECLARE @ISSUBUSER BIT
                SELECT TOP(1) @ISSUBUSER = 1
                FROM EMDS..STDUSER_HOTELS WITH(NOLOCK)
                WHERE SUBUSERID = @USERID

                DECLARE @ROLEID INT
                SELECT @ROLEID = ROLEID FROM EMDS..STDUSER WITH(NOLOCK) WHERE ID = @USERID

                IF (@IPADDRESS <> '10.0.0.0' OR @ISSUBUSER = 1) AND ISNULL(@ROLEID,0)<>191--2021-06-21:OGUZ/TOLGA:APIKEY ICIN BURAYA GEREKYOK..
                BEGIN TRY
                    declare @IPINT BIGINT
                    IF LEN(@IPADDRESS) < 16
                        select @IPINT=sum(CAST([value] AS BIGINT) * case octet when 1 then 256*256*256 when 2 then 256*256 when 3 then 256 when 4 then 1 end)
                        from(
                            SELECT [value] ,row_number()over(order by (select null)) AS octet
                            FROM string_split(@IPADDRESS,'.')
                        )tbl

                    DECLARE @AGENTID INT
                    SELECT  @AGENTID = ID FROM EMDS.dbo.STDUSERAGENT WITH(NOLOCK) WHERE [NAME] = @USERAGENT
                    IF @AGENTID IS NULL AND @USERAGENT > ''
                    BEGIN
                        INSERT INTO STDUSERAGENT([NAME])VALUES(@USERAGENT)
                        SET @AGENTID = SCOPE_IDENTITY()
                    END

                    DECLARE @LASTLOGINAT DATETIME
                    SELECT TOP(1) @LASTLOGINAT = [LOGINAT]
                    FROM STDUSER_LOGIN WITH(NOLOCK)
                    WHERE [USERID] = @USERID
                      AND [LOGINAT] > DATEADD(MINUTE,-3,GETUTCDATE())
                      AND [IP] = @IPADDRESS

                    IF @LASTLOGINAT IS NULL
                    BEGIN
                        INSERT INTO STDUSER_LOGIN([LOGINAT],[USERID],[IPV4],[AGENTID],[COUNTRYCODE],[IP])
                        VALUES(GETUTCDATE(),@USERID,@IPINT,@AGENTID,@IPCOUNTRY,@IPADDRESS)

                        --2021-02-26:OGUZ:TAKIP ICIN
                        UPDATE STDUSER  WITH(READPAST)
                        SET LASTLOGINDATE = GETUTCDATE(),
                            LASTLOGINIP   = @IPADDRESS
                        WHERE ID = @USERID
                          AND [HOTELID] <> 18892
                    END
                END TRY
                BEGIN CATCH
                    PRINT 'LOGIN LOG INSERT FAILED:'
                    PRINT ERROR_MESSAGE()
                END CATCH


                --2021-05-26:OGUZ:SUPERADMINLERIN TAKIBI ICIN
                IF LEFT(@USERID,1)='-'
                BEGIN TRY
                    exec sp_Executesql
                        N'UPDATE ANGUSDEVELOPER SET LOGINTIME = GETUTCDATE() WHERE ID = @USERID',
                        N'@USERID INT',@USERID
                END TRY
                BEGIN CATCH

                END CATCH


              GO
              /****** Object:  StoredProcedure [dbo].[SP_BEFORELOGIN]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE PROC [dbo].[SP_BEFORELOGIN]
              	@USERID NVARCHAR(50),
              	@TENANTID NVARCHAR(50),
              	@IPADDRESS NVARCHAR(50)
              AS

              IF (SELECT COUNT(*) FROM EMDS..HOTEL ) < 5
                RETURN

              --LOGGED IN USER DETAILS
              DECLARE @WHITELIST NVARCHAR(MAX),
              		@2FASTATE TINYINT,
              		@ROLEID INT
              select @WHITELIST=U.IPADDRESS,@2FASTATE = U.[2FASTATE],@ROLEID = U.ROLEID
              FROM ANGUS_WEBHOTEL..VW_USER U WITH(NOLOCK)
              WHERE U.USERID = @USERID

              --2021-06-30:IF 2FA ENABLED NO NEED FOR FURTHER CHECKS
              IF @2FASTATE > 2
              	RETURN

              --2020-09-30:SKIP FOR ROLES
              IF @ROLEID IN(131,141,145,154,155,191)
              	RETURN

              DECLARE @IPCOUNTRY NVARCHAR(2),@IPLANGUAGE NVARCHAR(2)
              SELECT  @IPCOUNTRY = [COUNTRYCODE],@IPLANGUAGE = LANGUAGECODE FROM EMDS..STDIP WITH(NOLOCK) WHERE [IP] = @IPADDRESS

              --2021-04-22:OGUZ:INGENICO SERVISI ICIN EKSTRA KORUMA
              IF @USERID = '-115' AND LEFT(@IPADDRESS,3)<>'10.' AND @IPADDRESS <> '20.54.125.192'
              BEGIN
              	SELECT
              		CAST(1 AS BIT) AS BLOCK,
              		'This is a special integration user that can only login from an internal IP' AS [MESSAGE],
              		'90' AS CODE
              	RETURN
              END


              --2021-04-19:OGUZ
              IF @USERID < 0 AND @USERID NOT IN(-139/*rebegia*/) AND ISNULL(@IPCOUNTRY,'')<>'TR' AND @IPADDRESS NOT IN('40.69.91.19','13.70.199.232','20.52.123.158','20.54.125.192') AND LEFT(@IPADDRESS,3)<>'10.'
              BEGIN
              	SELECT
              		CAST(1 AS BIT) AS BLOCK,
              		'Your login attempt seems suspicious, please contact Can Temizkan ('+@IPADDRESS+')' AS [MESSAGE],
              		'90' AS CODE
              	RETURN
              END

              --REMOTE LOGIN
              IF @IPADDRESS IN('40.69.204.40','40.127.101.2','5.25.222.183','13.70.199.232','40.69.91.19','20.54.125.192','20.52.123.158') OR LEFT(@IPADDRESS,3) = '11.' OR LEFT(@IPADDRESS,3) = '10.'
              	RETURN

              --IP WHITELISTED
              IF GETUTCDATE() < ( SELECT TOP(1) [ALLOWUNTIL] FROM IP_WHITELIST WITH(NOLOCK) WHERE [IPADDRESS] = @IPADDRESS)
              	RETURN

              --USER IS ADMIN
              IF @USERID < 0
              BEGIN
              	--BIR ADMIN SISTEME LOGIN OLDU MU ONUN ADRESI 24 SAATLIGINE GUVENILIR IP OLUR...
              	;MERGE TOP(1) IP_WHITELIST AS T
              	USING (SELECT TOP(1) * FROM ERSDEVELOPER..ANGUSDEVELOPER AS S WHERE S.[ID] = @USERID) AS S
              	ON T.IPADDRESS = @IPADDRESS
              	WHEN NOT MATCHED THEN INSERT (IPADDRESS,NOTES)VALUES(@IPADDRESS,S.USERCODE+'(ADMIN-LOGIN)')
              	WHEN MATCHED AND ALLOWUNTIL < DATEADD(DAY,1,GETUTCDATE()) THEN UPDATE SET ALLOWUNTIL = DATEADD(DAY,1,GETUTCDATE());

              	RETURN
              END

              --DEMO HOTEL IS FREE TO ACCESS
              IF @TENANTID IN(18892,19705,20854)
              	RETURN

              --NEW GROUPID
              DECLARE @NEWGROUPID INT ,@HOTELCOUNTRY NVARCHAR(2),@HOTELLANGUAGE NVARCHAR(2)
              SELECT
              	@NEWGROUPID = GROUPID ,
              	@HOTELCOUNTRY = DEFAULTLANGUAGE,
              	@HOTELLANGUAGE = DEFAULTLANGUAGE
              FROM EMDS..HOTEL WITH(NOLOCK)
              WHERE ID = @TENANTID

              --ISDEMO
              DECLARE @ISDEMO BIT
              SELECT TOP(1) @ISDEMO = DEMOMODE
              FROM EMDS..HOTEL_SUBSCRIPTION WITH(NOLOCK)
              WHERE OTELID = @TENANTID
              ORDER BY ID DESC

              --2020-09-04:OGUZ/GIZEM:KEMAL BEY DEMIS
              IF @ISDEMO = 1
              	RETURN

              --ALREADY WHITELISTED
              IF EXISTS(SELECT TOP(1) 1 FROM string_split(@WHITELIST,',') WHERE [value]=@IPADDRESS)
              	RETURN

              --2FA IS ACTIVE
              IF @2FASTATE IN(3,4)
              	RETURN

              --ACCESSED HOTELS
              DECLARE @ACCESSEDHOTELS INT,
              		@ACCESSEDTHISHOTEL BIT,
              		@MAXGROUPID INT
              SELECT
              	@ACCESSEDHOTELS = COUNT(DISTINCT ISNULL(H.GROUPID,H.ID)),
              	@ACCESSEDTHISHOTEL = MAX(CASE WHEN IH.HOTELID = @TENANTID THEN 1 ELSE 0 END ),
              	@MAXGROUPID = MAX(H.GROUPID)
              FROM IP_HOTEL IH WITH(NOLOCK)
              INNER JOIN EMDS..HOTEL H WITH(NOLOCK) ON H.ID = IH.HOTELID
              WHERE IH.IPADDRESS = @IPADDRESS

              --2021-04-15:OGUZ: HEM 2FA YOK! HEM IP SAFE DEGIL! HEM DE BASKA ULKEDEN GIRIS YAPILIYOR !!!
              IF  ISNULL(@2FASTATE,0)=0
              AND ISNULL(@WHITELIST,'') NOT LIKE '%[0-9]%'
              AND @IPCOUNTRY  <> @HOTELCOUNTRY
              AND @IPLANGUAGE <> @HOTELLANGUAGE
              BEGIN
              	SELECT
              		CAST(1 AS BIT) AS BLOCK,
              		'Your ip{{ "{{" }}'+@IPADDRESS+'}} seems suspicious, please contact support to get it whitelisted' AS MESSAGE,
              		'90' AS CODE
              	RETURN
              END

              IF ISNULL(@2FASTATE,0)=0 AND (CASE WHEN ISNULL(@ACCESSEDTHISHOTEL,0) = 1 OR @NEWGROUPID = @MAXGROUPID THEN 0 ELSE 1 END + @ACCESSEDHOTELS) > 3
              BEGIN
              	SELECT
              		CAST(1 AS BIT) AS BLOCK,
              		'Your ip{{ "{{" }}'+@IPADDRESS+'}} seems suspicious, please contact support to get it whitelisted' AS MESSAGE,
              		'90' AS CODE
              END
              ELSE
              BEGIN
              	IF @ACCESSEDTHISHOTEL = 1
              		UPDATE IP_HOTEL
              		SET LASTACCESS = GETUTCDATE(),
              			USERID = @USERID
              		WHERE IPADDRESS = @IPADDRESS
              		  AND HOTELID = @TENANTID
              	ELSE
              		INSERT INTO IP_HOTEL([IPADDRESS], [HOTELID], [USERID], [FIRSTACCESS], [LASTACCESS])
              		VALUES(@IPADDRESS,@TENANTID,@USERID,GETUTCDATE(),GETUTCDATE())
              END
              GO
              /****** Object:  StoredProcedure [dbo].[SP_GETDB]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO

              CREATE PROCEDURE [dbo].[SP_GETDB]
              	@TIMESTAMP DATETIME = null
              AS

              IF @TIMESTAMP IS NULL
              	SET @TIMESTAMP = '2020-10-01'
              IF @TIMESTAMP < '2020-09-01'
              	SET @TIMESTAMP = '2020-09-01'

              SELECT [COMMAND]  AS [SQL]
              FROM(
              	SELECT [WHEN],[COMMAND]
              	FROM [DDLEVENTS].[dbo].[DDLHISTORY] WITH(NOLOCK)
              	WHERE [DBNAME] = 'EMDS'
              	AND [WHEN] >= @TIMESTAMP
              	AND [DBUSER] <> 'NT AUTHORITY\SYSTEM'

              	UNION ALL

              	SELECT
              		[CREATEDATE],
              		'DELETE FROM [ANGUS_WEBHOTEL].[dbo].[CONFIG] WHERE [KEY]='+CONVERT(NVARCHAR(MAX),CONVERT(VARBINARY(MAX),[KEY]),1)+';'+
              		'INSERT INTO [ANGUS_WEBHOTEL].[dbo].[CONFIG]([KEY],[VALUE],[CREATEDATE])VALUES('+CONVERT(NVARCHAR(MAX),CONVERT(VARBINARY(MAX),[KEY]),1)+','+CONVERT(NVARCHAR(MAX),CONVERT(VARBINARY(MAX),[VALUE]),1)+','''+CONVERT(NVARCHAR,[CREATEDATE],121)+''')'
              	FROM [CONFIG] WITH(NOLOCK)
              	WHERE [CREATEDATE] >= @TIMESTAMP
              )AS TBL
              ORDER BY [WHEN]
              GO
              /****** Object:  StoredProcedure [dbo].[SP_LOGOUT]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO



              CREATE PROC [dbo].[SP_LOGOUT]
              	@USERID VARCHAR(50)
              AS

              IF TRY_PARSE(@USERID AS INT) > 0
              BEGIN
              	UPDATE EMDS..[STDUSER]
              	SET [LOGOUTTIME] = getutcdate()
              	WHERE ID = @USERID
              	  AND HOTELID NOT IN(18892)--DEMO HOTELS
              	  AND ROLEID NOT IN(SELECT ID FROM EMDS..STDROLE WITH(NOLOCK) WHERE ROLENAME LIKE 'POS%')--POS USERS SHOULD NOT BE LOGGED OUT
              END
              IF TRY_PARSE(@USERID AS INT) < 0
              BEGIN
              	UPDATE ERSDEVELOPER..ANGUSDEVELOPER
              	SET [LOGOUTTIME] = getutcdate()
              	WHERE ID = @USERID
              END

              SELECT @@ROWCOUNT AS UPDATEDONE
              GO
              /****** Object:  StoredProcedure [dbo].[SP_REFRESH_LOGSUMMARY]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE PROC [dbo].[SP_REFRESH_LOGSUMMARY]
              AS
              ------------------------------------------------------
              --2021-02-03:OGUZ:LOG OZETI YARATIMI------------------
              --GECELERI LOGLAR TEMIZLENMEDEN HEMEN ONCE CALISIR----
              --AGENT JOB NAME:Delete EasyPms Select/Function Logs--
              ------------------------------------------------------



              --CREATE TABLE LOGSUMMARY(
              --	HOTELID INT NOT NULL,[USER] NVARCHAR(100) NOT NULL COLLATE LATIN1_GENERAL_CI_AI,[OBJECT] NVARCHAR(100) NOT NULL COLLATE LATIN1_GENERAL_CI_AI,
              --	[Select]      INT NOT NULL DEFAULT 0,
              --	[Insert]      INT NOT NULL DEFAULT 0,
              --	[Update]      INT NOT NULL DEFAULT 0,
              --	[Delete]      INT NOT NULL DEFAULT 0,
              --	[Execute]     INT NOT NULL DEFAULT 0,
              --	[ApiSequence] INT NOT NULL DEFAULT 0,
              --	[Function]    INT NOT NULL DEFAULT 0,
              --	[SetConfig]   INT NOT NULL DEFAULT 0,
              --	[Login]       INT NOT NULL DEFAULT 0,
              --  PRIMARY KEY([HOTELID],[USER],[OBJECT])
              --)

              TRUNCATE TABLE LOGSUMMARY

              DECLARE @HOTELID INT,@USER NVARCHAR(100),@OBJECT NVARCHAR(100),@ACTION VARCHAR(11),@INCREASE INT
              DECLARE @SQL NVARCHAR(MAX),
              		@ROWCOUNT INT

              DECLARE C CURSOR LOCAL STATIC FOR
              SELECT ISNULL(HOTELID,0),ISNULL(USERID,''),ISNULL([OBJECT],''),ISNULL([ACTION],''),COUNT(ID)
              FROM EMDS_LOGS.dbo.[LOG_ELEKTRAWEB] L WITH(NOLOCK,INDEX=IX_LOGTIME)
              WHERE L.LOGTIMEUTC BETWEEN DATEADD(DAY,-1,GETUTCDATE()) AND GETUTCDATE()
              GROUP BY ISNULL(HOTELID,0),ISNULL(USERID,''),ISNULL([OBJECT],''),ISNULL([ACTION],'')

              OPEN C

              WHILE 1=1
              BEGIN TRY
              	FETCH NEXT FROM C INTO @HOTELID,@USER,@OBJECT,@ACTION,@INCREASE
              	IF @@FETCH_STATUS<>0
              		BREAK

              	SET @SQL = 'UPDATE LOGSUMMARY SET ['+@ACTION+'] += @INCREASE WHERE [HOTELID]=@HOTELID AND [USER] = @USER AND [OBJECT] = @OBJECT; SELECT @ROWCOUNT = @@ROWCOUNT'
              	exec sp_executesql @SQL,N'@HOTELID INT,@USER nvarchar(100),@OBJECT nvarchar(100),@INCREASE INT,@ROWCOUNT INT OUTPUT',@HOTELID,@USER,@OBJECT,@INCREASE,@ROWCOUNT OUTPUT

              	IF @ROWCOUNT = 0
              	BEGIN
              		INSERT INTO LOGSUMMARY(HOTELID,[USER],[OBJECT])VALUES(@HOTELID,@USER,@OBJECT)
              		exec sp_executesql @SQL,N'@HOTELID INT,@USER nvarchar(100),@OBJECT nvarchar(100),@INCREASE INT,@ROWCOUNT INT OUTPUT',@HOTELID,@USER,@OBJECT,@INCREASE,@ROWCOUNT OUTPUT
              	END

              END TRY
              BEGIN CATCH

              END CATCH

              CLOSE C
              DEALLOCATE C
              GO
              /****** Object:  StoredProcedure [dbo].[SP_SEND2FASMS]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE PROC [dbo].[SP_SEND2FASMS]
              	@USERID VARCHAR(50)
              AS

              DECLARE @USERID_INT INT = TRY_PARSE(@USERID AS INT)
              DECLARE @SMSCODE VARCHAR(6)
              DECLARE @OLDKEYVALIDUNTIL DATETIME
              DECLARE @PHONE VARCHAR(50)
              DECLARE @SUCCESS BIT = 0

              IF @USERID_INT > 0
              	SELECT @PHONE = PHONE
              	FROM EMDS..[STDUSER] WITH(NOLOCK)
              	WHERE ID = @USERID_INT
              IF @USERID_INT < 0
              	SELECT @PHONE = PHONE
              	FROM ERSDEVELOPER..ANGUSDEVELOPER WITH(NOLOCK)
              	WHERE ID = @USERID_INT

              IF @PHONE LIKE '+905_________'
              BEGIN
              	SELECT
              		@SMSCODE = [SMSCODE],
              		@OLDKEYVALIDUNTIL = [VALIDUNTIL_UTC]
              	FROM USER2FA WITH(NOLOCK)
              	WHERE USERID = @USERID

              	IF @OLDKEYVALIDUNTIL IS NULL OR @OLDKEYVALIDUNTIL < GETUTCDATE()
              	BEGIN
              		SET @SMSCODE = STUFF(FORMAT(RAND(),'0.000000'),1,2,'')

              		DELETE FROM USER2FA WHERE USERID = @USERID
              		INSERT INTO USER2FA(USERID,SMSCODE,VALIDUNTIL_UTC)VALUES(@USERID,@SMSCODE,DATEADD(MINUTE,3,GETUTCDATE()))

              		INSERT INTO EMDS..SMS(PHONE,CONTENT)
              		VALUES(STUFF(@PHONE,1,3,''),'ElektraWeb login code:' + cast(@SMSCODE as nvarchar(6)))
              	END

              	SET @SUCCESS = 1


              	--CREATE TABLE USER2FA(USERID VARCHAR(50) PRIMARY KEY,[SMSCODE] VARCHAR(6),[VALIDUNTIL_UTC] DATETIME)
              END

              SELECT @SUCCESS AS [SUCCESS]
              GO
              /****** Object:  StoredProcedure [dbo].[SP_SET2FAKEY]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO


              CREATE PROC [dbo].[SP_SET2FAKEY]
              	@USERID VARCHAR(50),
              	@2FAKEY VARCHAR(50),
              	@2FASTATE TINYINT
              AS

              IF TRY_PARSE(@USERID AS INT) > 0
              BEGIN
              	UPDATE EMDS..[STDUSER]
              	SET [2FAKEY] = @2FAKEY,
              		[2FASTATE] = CASE WHEN @2FASTATE = 3 AND ISNULL([IPADDRESS],'') LIKE '%[0-9]%' THEN 4 ELSE @2FASTATE END--2020-08-19:OGUZ:EGER KI IP TANIMI VARDIYSA, 2FA TAMAMLANDIGINDA OTOMATIK 4'E YANI GUVENLIRIIP MODUNA GECSIN
              	WHERE ID = @USERID
              END
              IF TRY_PARSE(@USERID AS INT) < 0
              	UPDATE ERSDEVELOPER..ANGUSDEVELOPER
              	SET [2FAKEY] = @2FAKEY,
              		[2FASTATE] = @2FASTATE
              	WHERE ID = @USERID
              GO
              /****** Object:  Trigger [dbo].[TRG_LOG_HOTELID]    Script Date: 17.08.2021 4:34:35 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO
              CREATE TRIGGER [dbo].[TRG_LOG_HOTELID]
              ON [dbo].[LOG_OLD] AFTER INSERT
              AS
              BEGIN
              	--2019-08-15:OGUZ
              	UPDATE [LOG]
              	SET [HOTELID] =
              		CASE
              			WHEN [ACTION] = 'Select' THEN (SELECT TOP(1) [Value] FROM OPENJSON([BODY],'$.Where')WITH([Column] nvarchar(max),[Value] nvarchar(max))WHERE [Column] = 'HOTELID' AND ISNUMERIC([Value])=1)
              			WHEN [OBJECT] = 'HOTEL'  THEN [ROWID]
              			WHEN [ACTION] = 'Delete' THEN (SELECT TOP(1) [L2].[HOTELID] FROM [LOG] L2 WITH(NOLOCK) WHERE L2.[OBJECT] = [LOG].[OBJECT] AND L2.[ROWID] = [LOG].[ROWID] AND [L2].[HOTELID] IS NOT NULL)
              			WHEN ISJSON([BODY]) = 1  THEN TRY_PARSE(JSON_VALUE([BODY],'$.HOTELID') AS INT)
              		END
              	WHERE ID IN(
              		SELECT ID
              		FROM inserted
              		WHERE [HOTELID] IS NULL
              	)
              END
              GO
              ALTER TABLE [dbo].[LOG_OLD] ENABLE TRIGGER [TRG_LOG_HOTELID]
              GO
              /****** Object:  DdlTrigger [TRG_OGUZ_SCHEMALOG]    Script Date: 17.08.2021 4:34:37 PM ******/
              SET ANSI_NULLS ON
              GO
              SET QUOTED_IDENTIFIER ON
              GO

              	CREATE TRIGGER [TRG_OGUZ_SCHEMALOG]
              	ON DATABASE FOR
              		DDL_DATABASE_LEVEL_EVENTS
              	AS

              	SET NOCOUNT ON

              	DECLARE @XML XML = EventData()

              	IF DB_ID('DDLEVENTS') IS NOT NULL AND @XML.value('/EVENT_INSTANCE[1]/SchemaName[1]','nvarchar(max)') <> 'TEMP'
              		INSERT INTO DDLEVENTS.DBO.DDLHISTORY( [WHEN],DBUSER,DBNAME,COMMAND )
              		SELECT
              			 GETUTCDATE(),
              			 @XML.value('/EVENT_INSTANCE[1]/LoginName[1]','nvarchar(max)'),
              			 @XML.value('/EVENT_INSTANCE[1]/DatabaseName[1]','nvarchar(max)'),
              			 @XML.value('/EVENT_INSTANCE[1]/TSQLCommand[1]/CommandText[1]','nvarchar(max)')

              	SET NOCOUNT OFF
              GO
              ENABLE TRIGGER [TRG_OGUZ_SCHEMALOG] ON DATABASE
              GO
{{ end }}
