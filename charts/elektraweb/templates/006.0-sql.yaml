{{ if .Values.sql.install }}
# apiVersion: v1
# kind: PersistentVolume
# metadata:
#   name: mssql-data-pv
# spec:
#   claimRef:
#     name: mssql-data-pvc
#     namespace: default
#   capacity:
#     storage: {{ .Values.sql.storage.capacity }}
#   volumeMode: Filesystem
#   accessModes:
#     - ReadWriteMany
#   persistentVolumeReclaimPolicy: Delete
#   storageClassName: {{ .Values.sql.storage.storageClassName }}
#   local:
#     path: {{ .Values.sql.storage.localPath }}
# #  nodeAffinity:
# #    required:
# #      nodeSelectorTerms:
# #        - matchExpressions:
# #            - key: kubernetes.io/hostname
# #              operator: In
# #              values:
# #                - example-node
# ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mssql-data-pvc
  namespace: default
spec:
  storageClassName: {{ .Values.sql.storage.storageClassName }}
  accessModes:
    - {{ .Values.sql.storage.accessMode }}
  volumeMode: Filesystem
  resources:
    requests:
      storage: {{ .Values.sql.storage.capacity }}
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: sql
  namespace: default
  labels:
    k8s-app: sql
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: sql
  template:
    metadata:
      name: sql
      labels:
        k8s-app: sql
    spec:
      volumes:
        - name: mssql-data
          persistentVolumeClaim:
            claimName: mssql-data-pvc
      containers:
        - name: sql
          image: ghcr.io/travelaps/mssql2019fts:v2
          env:
            - name: ACCEPT_EULA
              value: 'Y'
            - name: SA_PASSWORD
              value: {{ .Values.sql.saPassword | quote }}
            - name: MSSQL_PID
              value: {{ .Values.sql.pid }}
            - name: MSSQL_AGENT_ENABLED
              value: {{ .Values.sql.agentEnabled | quote }}
            - name: MSSQL_TCP_PORT
              value: {{ .Values.sql.tcpPort | quote }}
            - name: MSSQL_MEMORY_LIMIT_MB
              value: {{ .Values.sql.memoryLimit | quote }}
          volumeMounts:
            - name: mssql-data
              mountPath: /var/opt/mssql/data
      imagePullSecrets:
        - name: regcred
      hostname: mssqlinst
---
kind: Service
apiVersion: v1
metadata:
  name: sql
  namespace: default
  labels:
    k8s-app: sql
spec:
  ports:
    - name: sql-port
      protocol: TCP
      port: {{ .Values.sql.tcpPort }}
      targetPort: {{ .Values.sql.tcpPort }}
  selector:
    k8s-app: sql
  type: ClusterIP
{{ end }}
